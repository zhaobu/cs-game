# mahjong.club

## 与客户端交互
* 用户首先通过luancher接口拿到club的ip+port
* 用户与club建立socket连接之后，进行一下操作
	* 1、发送handshake消息，club回应一个handshake消息
	* 2、发送handshakeAck
	* 3、客户端需要开启心跳，心跳间隔是handshake返回的`heartbeat`字段
	* 4、用户发送连接俱乐部消息
	* 5、连接俱乐部成功后，服务端推送当前进行中的房间列表给用户
	* 6、用户切换俱乐部时，需要先发送断开连接的消息

## 与游戏服交互
* 每个游戏服通过连接池方式与club进行连接，不会为每个房间都创建一个连接
* 房间在开始、加人、退人、解散、每局开始会推送对应的消息给club
* 活跃检测
	* 房间会以固定间隔`（每分钟）`向club发送活跃检测请求
	* club在收到活跃检测请求之后,会回应一个是否活跃的标志
		* 若房间活跃中，不做处理
		* 若房间不再活跃，则游戏服重新推送完整数据到club，帮助club恢复数据

## 热更规则
* 俱乐部数据保存在内存中，更新时，需要重启进程，内存中的全部数据丢失
* 重启后，用户会与club重新建立连接
* 通过`活跃监测`机制，所有的房间，都会在`1分钟`内会重新向club推送完整的房间数据
* club在收到房间推送过来的reload数据之后，会广播给已连接的俱乐部用户
* 即：俱乐部重启之后的一分钟内，客户端可能看不到部分房间数据，一分钟后，全部恢复


## 架构
### 前期

* 1、单台club服务器
* 2、游戏服务器开启连接池，与club服务器连接
* 3、用户连接club服务器
